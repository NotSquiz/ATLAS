# Claude Code CLI and MCP Protocol: January 2026 Reference

The Claude Code ecosystem has matured significantly since late 2024, with the SDK renamed to **Claude Agent SDK**, MCP reaching **spec version 2025-11-25**, and the hooks system now supporting **10 event types**. This reference provides verified command syntax and configuration details for building ATLAS.

---

## Claude Code CLI: headless execution and session control

### The `-p` flag enables non-interactive mode

The `-p` (or `--print`) flag is the primary mechanism for headless execution. It runs Claude Code without interactive UI and outputs results to stdout:

```bash
# Basic headless execution
claude -p "Analyze this codebase for security issues"

# With JSON output for programmatic parsing
claude -p "Review code quality" --output-format json

# Streaming JSON for real-time output processing
claude -p "Build an application" --output-format stream-json

# With tool restrictions and permissions
claude -p "Stage changes and write commits" \
  --allowedTools "Bash,Read,Write" \
  --permission-mode acceptEdits

# Pipe content into Claude
cat error.log | claude -p "Diagnose this error"
```

**Key flags for headless operations:**

| Flag | Purpose |
|------|---------|
| `--print`, `-p` | Enable non-interactive mode |
| `--output-format` | Set output: `text`, `json`, `stream-json` |
| `--allowedTools` | Whitelist specific tools (comma-separated) |
| `--disallowedTools` | Blacklist tools with pattern matching |
| `--append-system-prompt` | Add custom instructions (only with `-p`) |
| `--permission-mode` | Set to `default`, `plan`, `acceptEdits`, or `bypassPermissions` |

### Session resumption uses `--continue` and `--resume`

Both flags exist and enable multi-turn workflows:

```bash
# Continue the most recent conversation
claude -p "Now refactor for better performance" --continue

# Resume a specific session by ID
claude -p "Update the tests" --resume 550e8400-e29b-41d4-a716-446655440000

# Multi-turn workflow pattern
claude -p "Review this codebase for issues"
claude -p "Focus on the database queries" --continue
claude -p "Generate summary of all issues found" --continue

# Get session ID from JSON output for coordination
session_id=$(claude -p "Start analysis" --output-format json | jq -r '.session_id')
claude -p "Continue analysis" --resume "$session_id"
```

### The `--dangerously-skip-permissions` flag bypasses all safety checks

This flag is **officially intended only for isolated Docker containers with no internet access**. It enables fully unattended execution by bypassing all permission prompts:

```bash
# Only appropriate in isolated containers
claude -p "fix all lint errors" --dangerously-skip-permissions --output-format json
```

**Safer alternatives recommended by Anthropic:**
```bash
# Granular tool permissions (preferred)
claude -p "Update files" --allowedTools "Edit,Read,Bash(git:*)"

# Explicit blocking patterns
claude -p "Build project" --disallowedTools "Bash(rm:*),Bash(curl:*)"
```

---

## Programmatic access through the Claude Agent SDK

### Breaking change: SDK renamed in late 2025

The SDK underwent a namespace change that requires migration from 2024 code:

| Platform | Old Package | New Package (January 2026) |
|----------|-------------|---------------------------|
| Python | `claude-code-sdk` | `claude-agent-sdk` |
| TypeScript | `@anthropic-ai/claude-code` | `@anthropic-ai/claude-agent-sdk` |
| Type | `ClaudeCodeOptions` | `ClaudeAgentOptions` |

### Python SDK usage

```bash
pip install claude-agent-sdk
```

```python
import asyncio
from claude_agent_sdk import query, ClaudeAgentOptions, AssistantMessage, TextBlock

async def main():
    options = ClaudeAgentOptions(
        system_prompt="You are an expert Python developer",
        permission_mode='acceptEdits',
        cwd="/home/user/project",
        allowed_tools=["Read", "Write", "Bash"]
    )
    
    async for message in query(prompt="Create a web server", options=options):
        if isinstance(message, AssistantMessage):
            for block in message.content:
                if isinstance(block, TextBlock):
                    print(block.text)

asyncio.run(main())
```

### Custom in-process MCP tools

```python
from claude_agent_sdk import tool, create_sdk_mcp_server, ClaudeAgentOptions, ClaudeSDKClient

@tool("greet", "Greet a user", {"name": str})
async def greet_user(args):
    return {"content": [{"type": "text", "text": f"Hello, {args['name']}!"}]}

server = create_sdk_mcp_server(name="my-tools", version="1.0.0", tools=[greet_user])

options = ClaudeAgentOptions(
    mcp_servers={"tools": server},
    allowed_tools=["mcp__tools__greet"]
)

async with ClaudeSDKClient(options=options) as client:
    await client.query("Greet Alice")
```

### TypeScript/Node.js SDK

```bash
npm install @anthropic-ai/claude-agent-sdk
```

```typescript
import { query } from '@anthropic-ai/claude-agent-sdk';

const stream = query({
  prompt: "What files are in this directory?",
  options: {
    allowedTools: ["Bash", "Glob"],
    settingSources: ['project']
  }
});

for await (const item of stream) {
  if (item.type === 'assistant') {
    for (const chunk of item.message.content) {
      if (chunk.type === 'text') {
        console.log(chunk.text);
      }
    }
  }
}
```

---

## Current subagent architecture

Claude Code includes **3 built-in subagent types** plus support for custom agents:

| Subagent | Model | Mode | Purpose |
|----------|-------|------|---------|
| **General-Purpose** | Sonnet | Read/write | Complex multi-step operations, code modifications |
| **Plan** | Sonnet | Read-only | Research before presenting plans (auto-invoked in plan mode) |
| **Explore** | Haiku | Read-only | Rapid file discovery and codebase understanding |

**Custom subagents** are defined as Markdown files in `.claude/agents/` (project) or `~/.claude/agents/` (user):

```yaml
---
name: code-reviewer
description: Expert code reviewer. Use proactively after code changes.
tools: Read, Grep, Glob, Bash
model: sonnet
permissionMode: default
---
Your custom system prompt here...
```

---

## MCP specification: version 2025-11-25

### Configuration file locations differ by client

**For Claude Code:**
- Primary: `~/.claude.json`
- Project-level: `.claude.json` in project root

**For Claude Desktop:**
- macOS: `~/Library/Application Support/Claude/claude_desktop_config.json`
- Windows: `%APPDATA%\Claude\claude_desktop_config.json`

### MCP server configuration structure

```json
{
  "mcpServers": {
    "github": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_PERSONAL_ACCESS_TOKEN": "your_token"
      }
    },
    "remote-api": {
      "type": "http",
      "url": "https://mcp.example.com/mcp"
    }
  }
}
```

### Registering MCP servers with Claude Code

```bash
# Add HTTP server
claude mcp add --transport http notion https://mcp.notion.com/mcp

# Add stdio server
claude mcp add github -- npx -y @modelcontextprotocol/server-github

# With scope (user vs project)
claude mcp add github --scope user

# List and manage
claude mcp list
claude mcp remove server-name
```

### Transport recommendations

**STDIO for local servers** (default, recommended):
- Client spawns server as child process
- Communication via stdin/stdout
- No network overhead
- Ideal for CLI tools and desktop applications

**Streamable HTTP for remote/production** (supersedes SSE):
- Modern standard as of spec 2025-03-26
- Single HTTP endpoint for bidirectional messaging
- Supports stateful and stateless modes
- Better scalability for distributed deployments

### Python SDK: the `mcp` package

```bash
pip install "mcp[cli]"  # Version 1.25.0 as of December 2025
```

```python
from mcp.server.fastmcp import FastMCP

mcp = FastMCP("Demo Server")

@mcp.tool()
def add(a: int, b: int) -> int:
    """Add two numbers"""
    return a + b

@mcp.resource("greeting://{name}")
def get_greeting(name: str) -> str:
    return f"Hello, {name}!"

if __name__ == "__main__":
    mcp.run()  # stdio by default
    # mcp.run(transport="streamable-http", host="0.0.0.0", port=8000)
```

### FastMCP status: split architecture

**FastMCP 1.0** is merged into the official SDK at `mcp.server.fastmcp`. **FastMCP 2.0+** is a separate project with additional enterprise features:

```bash
pip install fastmcp  # Standalone FastMCP 2.0+
```

FastMCP 2.0 adds server composition, OpenAPI integration, and enterprise auth (Google, GitHub, Azure, Auth0).

---

## Hooks system: 10 event types with JSON-based I/O

### Available hook events

| Hook | Trigger | Can Block? |
|------|---------|------------|
| `PreToolUse` | After parameters created, before tool execution | Yes (exit 2) |
| `PostToolUse` | After tool completes | Feedback only |
| `UserPromptSubmit` | When user submits prompt | Yes (exit 2) |
| `Stop` | When main agent finishes | Yes (exit 2) |
| `SubagentStop` | When subagent finishes | Yes (exit 2) |
| `PermissionRequest` | When permission dialog shown | Yes (exit 2) |
| `Notification` | System notifications | No |
| `PreCompact` | Before context compaction | No |
| `SessionStart` | Session begins/resumes | No |
| `SessionEnd` | Session ends | No |

### Hook configuration in settings.json

Configuration lives in `~/.claude/settings.json` (user) or `.claude/settings.json` (project):

```json
{
  "hooks": {
    "PreToolUse": [{
      "matcher": "Bash",
      "hooks": [{
        "type": "command",
        "command": "$CLAUDE_PROJECT_DIR/.claude/hooks/validate-bash.py",
        "timeout": 60
      }]
    }],
    "PostToolUse": [{
      "matcher": "Write|Edit|MultiEdit",
      "hooks": [{
        "type": "command",
        "command": ".claude/hooks/check-style.sh"
      }]
    }],
    "Stop": [{
      "hooks": [{
        "type": "command",
        "command": ".claude/hooks/end-of-turn-check.sh"
      }]
    }]
  }
}
```

### Hook input JSON schema (received via stdin)

**PreToolUse input:**
```json
{
  "session_id": "abc123",
  "transcript_path": "/Users/.../.claude/projects/.../session.jsonl",
  "cwd": "/Users/...",
  "permission_mode": "default",
  "hook_event_name": "PreToolUse",
  "tool_name": "Write",
  "tool_input": {
    "file_path": "/path/to/file.txt",
    "content": "file content"
  },
  "tool_use_id": "toolu_01ABC123..."
}
```

**PostToolUse adds `tool_response`:**
```json
{
  "tool_response": {
    "filePath": "/path/to/file.txt",
    "success": true
  }
}
```

### Hook output JSON schema (write to stdout)

**PreToolUse decision output:**
```json
{
  "continue": true,
  "hookSpecificOutput": {
    "hookEventName": "PreToolUse",
    "permissionDecision": "allow",
    "permissionDecisionReason": "Approved by policy",
    "updatedInput": {
      "field_to_modify": "new value"
    }
  }
}
```

### Blocking with exit code 2

**Exit code 2 blocks execution** and feeds stderr back to Claude:

```bash
#!/bin/bash
# validate-bash.py - Block dangerous commands
input=$(cat)
if echo "$input" | grep -q "rm -rf"; then
  echo 'Dangerous command blocked: rm -rf not allowed' >&2
  exit 2
fi
exit 0
```

**Exit code meanings:**
- `0`: Success, continue normally
- `2`: **Block the operation**, stderr sent to Claude
- Other: Non-blocking error, stderr shown in verbose mode

### Async behavior

Hooks execute **in parallel by default** but are **synchronous** in that Claude Code waits for completion. For background execution, fork within your script:

```bash
#!/bin/bash
# Fire and forget
/path/to/background-task.sh &
exit 0
```

### Environment variables available to hooks

| Variable | Description |
|----------|-------------|
| `CLAUDE_PROJECT_DIR` | Absolute path to project root |
| `CLAUDE_CODE_REMOTE` | `"true"` if running in web environment |
| `CLAUDE_ENV_FILE` | File path for persisting env vars (SessionStart only) |

---

## Integration patterns for production

### Resource costs per Claude Code process

| Metric | Value |
|--------|-------|
| **Baseline memory** | 1.5-2GB per process |
| **Extended sessions** | 2-12GB over 30-60 minutes |
| **Node.js requirement** | 18+ (LTS recommended) |
| **Python requirement** | 3.10+ |

**Best practices for resource management:**
- Restart sessions periodically for long-running operations
- Use `/compact` to reduce context size
- Use `/clear` between unrelated tasks
- Keep CLAUDE.md files minimal
- Set timeouts: `timeout 300 claude -p "$prompt"`

### Multi-instance orchestration

```bash
# Parallel execution with session coordination
claude -p "Analyze API layer" --output-format json &
claude -p "Review database schema" --output-format json &
wait

# Sequential multi-turn
session=$(claude -p "Start review" --output-format json | jq -r '.session_id')
claude -p "Analyze security" --resume "$session"
claude -p "Generate report" --resume "$session"
```

### Rate limits and concurrency

Claude Code inherits API rate limits using a token bucket algorithm:
- **RPM**: Requests per minute
- **ITPM**: Input tokens per minute
- **OTPM**: Output tokens per minute

**Subscription limits** (Claude.ai):
- Pro: ~40-80 active Sonnet hours/week
- Max: Up to 480 Sonnet hours or 40 Opus hours/week

**Handling rate limits:**
```python
async def query_with_retry(prompt, max_retries=3):
    for attempt in range(max_retries):
        try:
            async for msg in query(prompt=prompt):
                yield msg
            return
        except RateLimitError:
            await asyncio.sleep(2 ** attempt * 10)
    raise Exception("Max retries exceeded")
```

---

## Breaking changes from 2024

| Change | Impact |
|--------|--------|
| SDK renamed | `claude-code-sdk` → `claude-agent-sdk` (Python), `@anthropic-ai/claude-code` → `@anthropic-ai/claude-agent-sdk` (TypeScript) |
| Type renamed | `ClaudeCodeOptions` → `ClaudeAgentOptions` |
| Explore subagent added | v2.0.17 introduced Haiku-powered Explore subagent |
| Plan subagent added | v2.0.24 introduced Plan subagent with resumption |
| MCP spec updated | Now at 2025-11-25 with Tasks primitive and improved OAuth |
| SSE deprecated | Streamable HTTP is now the recommended remote transport |

---

## Documentation sources

| Resource | URL |
|----------|-----|
| Claude Code Official Docs | https://code.claude.com/docs/en/overview |
| Headless Mode Reference | https://code.claude.com/docs/en/headless |
| Hooks Documentation | https://code.claude.com/docs/en/hooks |
| Subagents Reference | https://code.claude.com/docs/en/sub-agents |
| MCP Specification | https://modelcontextprotocol.io/specification/2025-11-25 |
| MCP Python SDK | https://github.com/modelcontextprotocol/python-sdk |
| Claude Agent SDK (Python) | https://github.com/anthropics/claude-agent-sdk-python |
| Claude Agent SDK (TypeScript) | https://github.com/anthropics/claude-agent-sdk-typescript |
| Best Practices | https://www.anthropic.com/engineering/claude-code-best-practices |

## Conclusion

For ATLAS development, the recommended integration path is the **Claude Agent SDK** (`claude-agent-sdk` for Python) combined with **MCP servers** for extensibility and the **hooks system** for orchestration control. Use `--output-format stream-json` with the `-p` flag for real-time headless processing, and implement session management via `--resume` for multi-turn workflows. Memory management is critical—expect **1.5-2GB per process** and implement periodic restarts for long-running operations. The hooks system provides comprehensive interception points, with **exit code 2** being the key mechanism for blocking operations programmatically.